<script>
const CSV_URL = "SEU_LINK_DO_CSV_AQUI";
let dados = [];
let anoAtual, mesAtual;

async function loadCSV() {
  const r = await fetch(CSV_URL, { cache: "no-store" });
  const t = await r.text();
  parseCSV(t);
  definirMesInicial();
  montarCalendario();
}

function parseCSV(texto) {
  const linhas = texto.trim().split(/\r?\n/);
  linhas.shift();

  dados = linhas.map(l => {
    const c = l.split(",");
    const [d, m, a] = c[0].split("/");
    return {
      data: new Date(a, m - 1, d),
      ativo: c[1],
      semana: c[2],
      pontos: +c[3],
      trades: +c[4],
      gain: +c[5],
      stop: +c[6],
      zero: +c[7]
    };
  });
}

function definirMesInicial() {
  // pega a data mais recente do CSV
  const ultimaData = dados.reduce((a, b) =>
    b.data > a.data ? b : a
  ).data;

  anoAtual = ultimaData.getFullYear();
  mesAtual = ultimaData.getMonth();
}

function montarCalendario() {
  const hoje = new Date();
  const primeiro = new Date(anoAtual, mesAtual, 1);
  const ultimo = new Date(anoAtual, mesAtual + 1, 0);

  const grid = document.getElementById("calendar");
  grid.innerHTML = "";

  for (let i = 0; i < primeiro.getDay(); i++) {
    grid.innerHTML += `<div class="day empty"></div>`;
  }

  for (let d = 1; d <= ultimo.getDate(); d++) {
    const dataAtual = new Date(anoAtual, mesAtual, d);
    const r = dados.find(x =>
      x.data.toDateString() === dataAtual.toDateString()
    );

    let classe = "day";
    let pontos = "";
    let info = "";
    let tooltip = "";

    if (r) {
      pontos = r.pontos;
      if (pontos > 0) classe += " positive";
      if (pontos < 0) classe += " negative";

      info = `
        Trades: ${r.trades}<br>
        Gain: ${r.gain} | Stop: ${r.stop} | 0x0: ${r.zero}
      `;

      tooltip = `
        <div class="tooltip">
          SEMANA ${r.semana}<br>
          ATIVO: ${r.ativo}
        </div>
      `;
    }

    if (
      dataAtual.toDateString() === hoje.toDateString() &&
      hoje.getMonth() === mesAtual &&
      hoje.getFullYear() === anoAtual
    ) {
      classe += " today";
    }

    grid.innerHTML += `
      <div class="${classe}">
        ${tooltip}
        <div class="day-number">${d}</div>
        <div class="day-points"
          style="color:${pontos < 0 ? 'var(--red)' : 'var(--green)'}">
          ${pontos}
        </div>
        <div class="day-info">${info}</div>
      </div>
    `;
  }
}

loadCSV();
</script>
